<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ‘¥ ØµÙØ­Ø© Ø§Ù„ÙØ±ÙŠÙ‚</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#000;color:#FFD700}
.container{max-width:1000px;margin:20px auto;padding:20px}
.box{
  background:#1a1400;border-radius:18px;padding:20px;margin-bottom:20px;
  box-shadow:0 0 20px #FFD70044
}
h2{text-align:center;margin-top:0}
.member{padding:10px;border-bottom:1px solid #FFD70033;font-size:14px}
.empty{text-align:center;color:#aaa}
.loading{text-align:center;color:#fff}
button{
  width:100%;padding:15px;border:none;border-radius:12px;
  background:#FFD700;color:#000;font-size:16px;font-weight:bold;cursor:pointer
}
.balance{font-size:22px;font-weight:bold;text-align:center}
</style>
</head>

<body>
<div class="container">

  <div class="box">
    <h2>ğŸ’° Ø±ØµÙŠØ¯ÙŠ</h2>
    <div id="myBalance" class="balance">0 Ø¯Ø¬</div>
  </div>

  <div class="box">
    <h2>ğŸ‘¥ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„</h2>
    <div id="team1"><div class="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
  </div>

  <div class="box">
    <h2>ğŸ‘¥ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ</h2>
    <div id="team2"></div>
  </div>

  <div class="box">
    <h2>ğŸ‘¥ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù„Ø«</h2>
    <div id="team3"></div>
  </div>

  <div class="box">
    <button id="calcBtn">ğŸ’° Ø§Ø­Ø³Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙØ±ÙŠÙ‚</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, collection, query, where, getDocs,
  doc, getDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAa6ETi1DmEI-3nVuqjpsaodT0rXsP8bIw",
  authDomain: "aple-21978.firebaseapp.com",
  projectId: "aple-21978"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª */
const LEVEL_AMOUNT = {
  1:2500, 2:5000, 3:10000, 4:15000,
  5:23000, 6:35000, 7:46000
};

/* Ù†Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (7 Ø£ÙƒØ¨Ø±) */
const LEVEL_PERCENT = {
  1:0.02, 2:0.05, 3:0.08, 4:0.10,
  5:0.15, 6:0.20, 7:0.30
};

/* Ø¹Ø§Ù…Ù„ Ø§Ù„ÙØ±Ù‚ */
const TEAM_FACTOR = {
  1:0.30, // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„
  2:0.20, // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ
  3:0.05  // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù„Ø«
};

let userId, myInviteCode, myBalance=0;
let team1=[], team2=[], team3=[];

/* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
onAuthStateChanged(auth, async user=>{
  if(!user) return;
  userId = user.uid;

  const meSnap = await getDoc(doc(db,"users",userId));
  if(!meSnap.exists()) return;

  const me = meSnap.data();
  myInviteCode = me.inviteCode;
  myBalance = me.balance || 0;
  document.getElementById("myBalance").innerText = myBalance+" Ø¯Ø¬";

  team1 = await getTeamByCode(myInviteCode);
  render(team1,"team1");

  team2 = await getNextTeamFast(team1);
  render(team2,"team2");

  team3 = await getNextTeamFast(team2);
  render(team3,"team3");
});

/* Ø¬Ù„Ø¨ ÙØ±ÙŠÙ‚ Ø¨Ø§Ù„ÙƒÙˆØ¯ */
async function getTeamByCode(code){
  if(!code) return [];
  const snap = await getDocs(
    query(collection(db,"users"), where("joinedBy","==",code))
  );
  return snap.docs;
}

/* Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ */
async function getNextTeamFast(prevTeam){
  if(prevTeam.length===0) return [];
  const codes = prevTeam.map(d=>d.data().inviteCode).filter(Boolean).slice(0,10);
  if(codes.length===0) return [];
  const snap = await getDocs(
    query(collection(db,"users"), where("joinedBy","in",codes))
  );
  return snap.docs;
}

/* Ø¹Ø±Ø¶ */
function render(arr,id){
  const box=document.getElementById(id);
  box.innerHTML="";
  if(arr.length===0){
    box.innerHTML=`<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡</div>`;
    return;
  }
  arr.forEach(d=>{
    const u=d.data();
    box.innerHTML+=`
      <div class="member">
        ğŸ‘¤ ${u.phone||"Ù…Ø³ØªØ®Ø¯Ù…"}<br>
        â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${u.level||0}<br>
        ğŸ§· Ø¢Ø®Ø± Ù…Ø³ØªÙˆÙ‰ Ù…Ø­Ø³ÙˆØ¨: ${u.lastRewardedLevel||0}
      </div>`;
  });
}

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ */
document.getElementById("calcBtn").onclick = async ()=>{
  let total = 0;

  const calcTeam = async (arr, teamLevel)=>{
    for(const d of arr){
      const u = d.data();
      const level = u.level || 0;
      const last = u.lastRewardedLevel || 0;

      if(level > last){
        const amount =
          LEVEL_AMOUNT[level] *
          LEVEL_PERCENT[level] *
          TEAM_FACTOR[teamLevel];

        total += amount;

        await updateDoc(doc(db,"users",d.id),{
          lastRewardedLevel: level
        });
      }
    }
  };

  await calcTeam(team1,1);
  await calcTeam(team2,2);
  await calcTeam(team3,3);

  if(total>0){
    await updateDoc(doc(db,"users",userId),{
      balance: increment(total)
    });
    myBalance += total;
    document.getElementById("myBalance").innerText =
      myBalance.toFixed(0)+" Ø¯Ø¬";
    alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "+total.toFixed(0)+" Ø¯Ø¬");
  }else{
    alert("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ø¨Ø§Ø­ Ø¬Ø¯ÙŠØ¯Ø©");
  }
};
</script>
</body>
</html>
